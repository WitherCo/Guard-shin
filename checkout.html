<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guard-shin Premium Checkout</title>
  <link rel="icon" type="image/png" href="./generated-icon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    :root {
      --color-bg-primary: #0f0f0f;
      --color-bg-secondary: #1a1a1a;
      --color-text-primary: #fff;
      --color-accent-primary: #8249F0;
      --color-accent-secondary: #6c3ad6;
      --transition-speed: 0.3s;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
    }
    
    body {
      background-color: var(--color-bg-primary);
      color: var(--color-text-primary);
      min-height: 100vh;
    }
    
    .checkout-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .navbar {
      background-color: var(--color-bg-secondary);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-accent-primary);
      text-decoration: none;
    }
    
    .logo i {
      font-size: 1.8rem;
    }
    
    .nav-links {
      display: flex;
      gap: 1.5rem;
    }
    
    .nav-links a {
      color: var(--color-text-primary);
      text-decoration: none;
      font-weight: 500;
      transition: color var(--transition-speed);
      padding: 0.5rem 0;
    }
    
    .nav-links a:hover {
      color: var(--color-accent-primary);
    }
    
    .main-content {
      flex: 1;
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }
    
    .checkout-header {
      margin-bottom: 2rem;
      text-align: center;
    }
    
    .checkout-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .checkout-subtitle {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1rem;
    }
    
    .checkout-form {
      background-color: var(--color-bg-secondary);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    select {
      width: 100%;
      padding: 0.75rem;
      border-radius: 6px;
      border: 1px solid #333;
      background-color: #252525;
      color: white;
      font-size: 1rem;
    }
    
    .payment-element {
      margin-bottom: 1.5rem;
    }
    
    .checkout-button {
      background-color: var(--color-accent-primary);
      color: white;
      border: none;
      width: 100%;
      padding: 1rem;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color var(--transition-speed);
    }
    
    .checkout-button:hover {
      background-color: var(--color-accent-secondary);
    }
    
    .checkout-button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    
    .payment-message {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 6px;
      text-align: center;
    }
    
    .error-message {
      background-color: rgba(255, 59, 48, 0.1);
      color: #ff3b30;
    }
    
    .success-message {
      background-color: rgba(52, 199, 89, 0.1);
      color: #34c759;
    }
    
    .hidden {
      display: none;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .footer {
      background-color: var(--color-bg-secondary);
      padding: 1.5rem 2rem;
      text-align: center;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
    }
    
    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
      }
      
      .checkout-form {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="checkout-container">
    <nav class="navbar">
      <a href="./index.html" class="logo">
        <i class="fas fa-shield-alt"></i>
        <span>Guard-shin</span>
      </a>
      <div class="nav-links">
        <a href="./index.html">Dashboard</a>
        <a href="./commands.html">Commands</a>
        <a href="./premium.html">Premium</a>
        <a href="./modern_support.html">Support</a>
        <a href="./modern_settings.html">Settings</a>
      </div>
    </nav>
    
    <div class="main-content">
      <div class="checkout-header">
        <h1 class="checkout-title">Complete Your Purchase</h1>
        <p class="checkout-subtitle">Upgrade your server with Guard-shin Premium features</p>
      </div>
      
      <div class="checkout-form">
        <div class="form-group">
          <label for="server-select">Select Your Server</label>
          <select id="server-select">
            <option value="" disabled selected>Loading servers...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="plan-select">Select Plan</label>
          <select id="plan-select">
            <option value="basic" data-price="4.99">Basic ($4.99/month)</option>
            <option value="standard" data-price="9.99" selected>Standard ($9.99/month)</option>
            <option value="premium" data-price="24.99">Premium ($24.99/month)</option>
            <option value="enterprise" data-price="99.99">Enterprise ($99.99/month)</option>
          </select>
        </div>
        
        <div id="payment-element" class="payment-element">
          <!-- Stripe Elements will be inserted here -->
          <div style="text-align: center; padding: 2rem 0;">
            <div class="loading-spinner"></div>
            <p>Loading payment form...</p>
          </div>
        </div>
        
        <button id="checkout-button" class="checkout-button" disabled>
          <span id="button-text">Subscribe Now</span>
        </button>
        
        <div id="payment-message" class="payment-message hidden"></div>
      </div>
    </div>
    
    <footer class="footer">
      &copy; 2025 Guard-shin by WitherCo. All rights reserved.
    </footer>
  </div>
  
  <script>
    // Fetch connected servers
    async function fetchServers() {
      try {
        const response = await fetch('/api/guilds');
        const data = await response.json();
        
        return data.guilds || [];
      } catch (error) {
        console.error('Error fetching servers:', error);
        
        // Fallback: Try to load from bot_guilds.json directly in development
        try {
          const fallbackResponse = await fetch('/bot_guilds.json');
          if (!fallbackResponse.ok) {
            throw new Error('Failed to fetch fallback server data');
          }
          
          const fallbackData = await fallbackResponse.json();
          return Array.isArray(fallbackData) ? fallbackData : [];
        } catch (fallbackError) {
          console.error('Error fetching fallback server data:', fallbackError);
          return [];
        }
      }
    }
    
    // Populate the server select dropdown
    async function populateServerSelect() {
      const serverSelect = document.getElementById('server-select');
      const servers = await fetchServers();
      
      if (servers.length === 0) {
        serverSelect.innerHTML = '<option value="" disabled selected>No servers available</option>';
        return;
      }
      
      let options = '<option value="" disabled selected>Select a server</option>';
      
      servers.forEach(server => {
        // Skip servers that already have premium
        if (server.isPremium) {
          options += `<option value="${server.id}" disabled>${server.name} (Already Premium)</option>`;
        } else {
          options += `<option value="${server.id}">${server.name}</option>`;
        }
      });
      
      serverSelect.innerHTML = options;
    }
    
    // Initialize Stripe
    function initializeStripe() {
      if (!STRIPE_PUBLIC_KEY) {
        document.getElementById('payment-element').innerHTML = '<div class="error-message">Stripe is not configured. Please contact support.</div>';
        return null;
      }
      
      return Stripe(STRIPE_PUBLIC_KEY);
    }
    
    // Get the selected plan price
    function getSelectedPrice() {
      const planSelect = document.getElementById('plan-select');
      const selectedOption = planSelect.options[planSelect.selectedIndex];
      return parseFloat(selectedOption.dataset.price);
    }
    
    // Get the selected server ID
    function getSelectedServerId() {
      const serverSelect = document.getElementById('server-select');
      return serverSelect.value;
    }
    
    // Update the button state based on form validity
    function updateButtonState() {
      const serverId = getSelectedServerId();
      const checkoutButton = document.getElementById('checkout-button');
      
      if (serverId) {
        checkoutButton.disabled = false;
      } else {
        checkoutButton.disabled = true;
      }
    }
    
    // Show a payment message (error or success)
    function showMessage(messageText, isError = false) {
      const messageElement = document.getElementById('payment-message');
      messageElement.textContent = messageText;
      messageElement.classList.remove('hidden', 'error-message', 'success-message');
      messageElement.classList.add(isError ? 'error-message' : 'success-message');
    }
    
    // Create a payment intent for one-time payment
    async function createPaymentIntent(amount, metadata) {
      try {
        const response = await fetch('/api/create-payment-intent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ amount, metadata }),
        });
        
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        
        return await response.json();
      } catch (error) {
        console.error('Error creating payment intent:', error);
        throw error;
      }
    }
    
    // Create a subscription
    async function createSubscription(priceId, metadata) {
      try {
        const response = await fetch('/api/get-or-create-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ priceId, metadata }),
        });
        
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        
        return await response.json();
      } catch (error) {
        console.error('Error creating subscription:', error);
        throw error;
      }
    }
    
    // Redirect to Stripe Checkout
    function redirectToStripeCheckout(serverId, plan) {
      let checkoutUrl;
      
      // Map plan to the appropriate Stripe Checkout URL
      switch (plan) {
        case 'basic':
          checkoutUrl = 'https://buy.stripe.com/00g01M01l69G4h228d';
          break;
        case 'standard':
          checkoutUrl = 'https://buy.stripe.com/dR65m6cO7eGc6pa3ci';
          break;
        case 'premium':
          checkoutUrl = 'https://buy.stripe.com/3cscOy6pJ9lS9Bm28f';
          break;
        case 'enterprise':
          checkoutUrl = 'https://buy.stripe.com/aEUg0KeWf55C3cY008';
          break;
        default:
          checkoutUrl = 'https://buy.stripe.com/dR65m6cO7eGc6pa3ci'; // Default to standard
      }
      
      // Add the guild_id as a URL parameter
      const urlWithParams = new URL(checkoutUrl);
      urlWithParams.searchParams.append('client_reference_id', serverId);
      
      // Redirect to Stripe Checkout
      window.location.href = urlWithParams.toString();
    }
    
    // Handle checkout form submission
    async function handleCheckout(event) {
      event.preventDefault();
      
      const serverId = getSelectedServerId();
      if (!serverId) {
        showMessage('Please select a server.', true);
        return;
      }
      
      const planSelect = document.getElementById('plan-select');
      const selectedPlan = planSelect.value;
      
      // Set button to loading state
      const button = document.getElementById('checkout-button');
      button.disabled = true;
      button.innerHTML = '<div class="loading-spinner"></div><span>Processing...</span>';
      
      try {
        // Currently, we're using Stripe Checkout hosted pages for simplicity
        redirectToStripeCheckout(serverId, selectedPlan);
      } catch (error) {
        console.error('Payment error:', error);
        showMessage('An error occurred during checkout: ' + error.message, true);
        button.disabled = false;
        button.innerHTML = '<span>Subscribe Now</span>';
      }
    }
    
    // Initialize the checkout page
    async function initCheckout() {
      // Populate the server dropdown
      await populateServerSelect();
      
      // Add event listeners
      document.getElementById('server-select').addEventListener('change', updateButtonState);
      document.getElementById('checkout-button').addEventListener('click', handleCheckout);
      
      // Update initial button state
      updateButtonState();
    }
    
    // Use the hardcoded Stripe public key (would be injected by server in production)
    // For real implementation, this would come from environment variables
    // In a Vite app, you'd use import.meta.env.VITE_STRIPE_PUBLIC_KEY
    // We're using direct Stripe checkout links so we don't need this key for now
    const STRIPE_PUBLIC_KEY = '';
    
    // Start the checkout process when the page loads
    document.addEventListener('DOMContentLoaded', initCheckout);
  </script>
</body>
</html>